# 后台统计上报


### 一 简述

由生产者通过消息队列发布消息，消费端订阅消息通道将日志写入ES。

由ES完成索引，通过Restful Api提供数据查询接口。

  

### 二 数据流向

![](https://i.loli.net/2019/07/31/5d41046b619dd32578.png)
  

### 三 性能问题

生产者，消费者，MQ，ES根据数据容量可以横向扩容，没有单点问题。

由report server创建生产者使用多线程并行发布消息，通过最大线程数控制线程池大小。

消费端使用多线程消费消息，通过ES Bulk Api批量写入ES。

查询接口通过ES multi search api合并查询请求，一次返回。

  

### 四 可靠性问题

1\. 持久化

设置交换机，队列，消息持久化存储，数据写入磁盘，服务异常不丢数据。

2\. 消息确认

由消息消费端进行消息确认

消息由生产者发送至broker产生消息确认回调，确保消息写入磁盘，消息发送失败后不会丢失。

3\. dead letter

消息被拒绝，TTL过期，超过队列最大长度时，消息变成dead letter，收集这些消息查看失败原因。

4\. 重试策略

消息发送失败后，使用指数退避算法重新尝试发送消息，直到达到最大重试次数，记录错误日志。

  

### 五 流程简述
![](https://i.loli.net/2019/07/31/5d4104967526d40604.png)